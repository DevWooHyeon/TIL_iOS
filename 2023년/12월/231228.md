# TIL

### ğŸ”¥ URLSession ì´ë€?

<img width="900" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-12-30 á„‹á…©á„Œá…¥á†« 2 39 15" src="https://github.com/DevWooHyeon/TodayILearn_TIL/assets/123448121/d6e9b630-5948-496d-ae9e-e2e93fdc8f35">

`"ê´€ë ¨ëœ ë„¤íŠ¸ì›Œí¬ ë°ì´í„° ì „ì†¡ ì‘ì—… ê·¸ë£¹ì„ ì¡°ì •í•˜ëŠ” ê°œì²´ì…ë‹ˆë‹¤."` ë¼ê³  ê³µì‹ë¬¸ì„œì—ëŠ” ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤.

ì¦‰ ë„¤íŠ¸ì›Œí¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ê°ì²´ ì…ë‹ˆë‹¤.

URLSessionì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ê³  ì›¹ ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

URLSessionì€ `ë¹„ë™ê¸°ì ìœ¼ë¡œ ë™ì‘`í•˜ë©° ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

***

### ğŸ”¥ URLSession Configuration

#### âœ… Shared Session(ê³µìœ  ì„¸ì…˜)

`URLSession.Shared()`

- ê¸°ë³¸ ìš”ì²­í•˜ê¸° ìœ„í•œ ì„¸ì…˜
- ì‹±ê¸€í†¤ìœ¼ë¡œ ì‚¬ìš©
- ë§ì¶¤ ì„¤ì •ì€ ë¶ˆê°€í•˜ì§€ë§Œ ì‰½ê²Œ ë§Œë“¤ì–´ ì‚¬ìš© ê°€ëŠ¥

#### âœ… Default Session(ê¸°ë³¸ ì„¸ì…˜)

`URLSession(configuration: .default)`

- ê³µìœ  ì„¸ì…˜ê³¼ ìœ ì‚¬í•˜ê²Œ ì‘ë™í•˜ì§€ë§Œ, ì§ì ‘ ì›í•˜ëŠ” ì„¤ì •ì„ í•  ìˆ˜ ìˆìŒ
- ìˆœì°¨ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ Delegate ì§€ì • ê°€ëŠ¥
- ìºì‹œì™€ ì¿ í‚¤, ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë“±ì„ ë””ìŠ¤í¬ì— ì €ì¥

#### âœ… Ephemeral Session(ì„ì‹œ ì„¸ì…˜)

`URLSession(configuration: .ephemeral)`

- ê³µìœ  ì„¸ì…˜ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ ìºì‹œ, ì¿ í‚¤, ì‚¬ìš©ì ì¸ì¦ ì •ë³´(ìê²© ì¦ëª…)ë“±ì„ ë””ìŠ¤í¬ì— ì €ì¥í•˜ì§€ ì•ŠìŒ
- ë©”ëª¨ë¦¬ì— ì˜¬ë ¤ ì„¸ì…˜ì„ ì—°ê²°í•˜ê³  ì„¸ì…˜ ë§Œë£Œì‹œ ë°ì´í„°ê°€ ì‚¬ë¼ì§.

#### âœ… Background Session(ë°±ê·¸ë¼ìš´ë“œ ì„¸ì…˜)

`URLSession(configuration: .background)`

- ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ë™ì•ˆ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì»¨í…ì¸  ì—…ë¡œë“œ ë° ë‹¤ìš´ë¡œë“œ ìˆ˜í–‰

***

### ğŸ”¥ URLSession Task ìœ í˜•

#### âœ… URLSessionDataTask
- ë°ì´í„° ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ìš”ì²­í•˜ê³  ì‘ë‹µ ë°›ìŒ
- ì£¼ë¡œ ì§§ê³  ë¹ˆë²ˆí•˜ê²Œ ìš”ì²­í•  ë•Œ ì‚¬ìš©

#### âœ… URLSessionUploadTask
- DataTaskì™€ ìœ ì‚¬
- ë°ì´í„° ê°ì²´ ë˜ëŠ” íŒŒì¼ í˜•íƒœì˜ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰
- ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ì„ë•Œ ë°±ê·¸ë¼ìš´ë“œ ì—…ë¡œë“œë¥¼ ì§€ì›

#### âœ… URLSessionDownloadTask
- ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì„œ íŒŒì¼ í˜•íƒœë¡œ ì €ì¥í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰
- ì•±ì´ ì‹¤í–‰ì¤‘ì´ì§€ ì•Šì€ ë•Œì—ëŠ” ë°±ê·¸ë¼ìš´ë“œ ë‹¤ìš´ë¡œë“œ ë° ì—…ë¡œë“œ ë¥¼ ì§€ì›

#### âœ… URLSessionStreamTask
- TCP/IPì— ì—°ê²°ì„ ìƒì„±í•  ë•Œ ì‚¬ìš©

~~~
ì‘ì—…ì„ ìƒì„±í•œ í›„ì— `resume()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤. 
~~~

***

### ğŸ”¥ Complition handler ë¡œ ê²°ê³¼ ë°›ì•„ì˜¤ê¸°

ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ Complition handler ë¥¼ ì‚¬ìš©í•˜ì—¬ data taskë¥¼ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.

<img width="650" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-02 á„‹á…©á„’á…® 8 23 52" src="https://github.com/DevWooHyeon/TodayILearn_TIL/assets/123448121/a1748173-3be7-4316-9e24-3d5f393b92fc">

Complition handler ë¥¼ ì‚¬ìš©í•˜ë©´ 3ê°€ì§€ ì‘ì—…ì„ í•´ì•¼í•©ë‹ˆë‹¤.

- error ë§¤ê°œë³€ìˆ˜ê°€ nil ì¸ì§€ í™•ì¸ í•´ì•¼í•©ë‹ˆë‹¤.
  - ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²ƒì…ë‹ˆë‹¤.
  - ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
- response ìƒíƒœ ì½”ë“œê°€ ì„±ê³µì„ ë‚˜íƒ€ë‚´ëŠ”ì§€, MIME ìœ í˜•ì´ ì˜ˆìƒëœ ê°’ì¸ì§€ ë§¤ê°œë³€ìˆ˜ë¥¼ í†µí•´ í™•ì¸í•´ì•¼í•©ë‹ˆë‹¤.
  - ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° ì„œë²„ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
- í•„ìš”ì— ë”°ë¼ data ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

âœ… Complition handlerë¥¼ ì‚¬ìš©í•˜ëŠ” URLSession êµ¬í˜„
~~~ swift
func startLoad() {
    let url = URL(string: "https://www.example.com/")!
    let task = URLSession.shared.dataTask(with: url) { data, response, error in
        if let error = error {
            self.handleClientError(error)
            return
        }
        guard let httpResponse = response as? HTTPURLResponse,
            (200...299).contains(httpResponse.statusCode) else {
            self.handleServerError(response)
            return
        }
        if let mimeType = httpResponse.mimeType, mimeType == "text/html",
            let data = data,
            let string = String(data: data, encoding: .utf8) {
            DispatchQueue.main.async {
                self.webView.loadHTMLString(string, baseURL: url)
            }
        }
    }
    task.resume()
}
~~~

*** 

### ğŸ”¥ Delegate ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ë¶€ì ì¸ ê²°ê³¼ ë°›ì•„ì˜¤ê¸°

ì§„í–‰ë˜ëŠ” ì‘ì—… í™œë™ì— ëŒ€í•œ ë” ë†’ì€ ìˆ˜ì¤€ì˜ ì•¡ì„¸ìŠ¤ë¥¼ ìœ„í•´ data task ë¥¼ ìƒì„±í•  ë•Œ complition handler ë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  ì„¸ì…˜ì— delegateë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img width="650" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-02 á„‹á…©á„’á…® 8 30 36" src="https://github.com/DevWooHyeon/TodayILearn_TIL/assets/123448121/506f501f-36b1-44a6-b90b-f09065828f71">

delegate ë¥¼ ì‚¬ìš©í•˜ë©´ ì „ì†¡ì´ ì™„ë£Œë˜ê±°ë‚˜ ì˜¤ë¥˜ë¡œ ì¸í•´ ì‹¤íŒ¨í•  ë•Œê¹Œì§€

ë°ì´í„°ì˜ ì¼ë¶€ê°€ ë„ì°©í•˜ìë§ˆì ë©”ì„œë“œì— ì œê³µë©ë‹ˆë‹¤. ë˜í•œ delegate ëŠ” ì „ì†¡ì´ ì§„í–‰ë¨ì— ë”°ë¼ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì´ë²¤íŠ¸ë„ ìˆ˜ì‹ ê°€ëŠ¥í•©ë‹ˆë‹¤.

delegate ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” í´ë˜ìŠ¤ì˜ ë‹¨ìˆœ ì¸ìŠ¤í„´ìŠ¤(URLSession.Shared())ë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  ìì²´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

âœ… delegate ë¥¼ ì‚¬ìš©í•˜ëŠ” URLSession êµ¬í˜„
~~~ swift
private lazy var session: URLSession = {
    let configuration = URLSessionConfiguration.default
    configuration.waitsForConnectivity = true
    return URLSession(configuration: configuration,
                      delegate: self, delegateQueue: nil)
}()
~~~

delegate ë¥¼ ì‚¬ìš©í•˜ì—¬ data task ë¥¼ ì‹œì‘í•˜ê³  delegate callback ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì‹ ëœ ë°ì´í„°ì™€ error ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

âœ… URLSession data task ì— delegate ë¥¼ ì‚¬ìš©
~~~ swift
var receivedData: Data?


func startLoad() {
    loadButton.isEnabled = false
    let url = URL(string: "https://www.example.com/")!
    receivedData = Data()
    let task = session.dataTask(with: url)
    task.resume()
}


// delegate methods


func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse,
                completionHandler: @escaping (URLSession.ResponseDisposition) -> Void) {
    guard let response = response as? HTTPURLResponse,
        (200...299).contains(response.statusCode),
        let mimeType = response.mimeType,
        mimeType == "text/html" else {
        completionHandler(.cancel)
        return
    }
    completionHandler(.allow)
}


func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data) {
    self.receivedData?.append(data)
}


func urlSession(_ session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?) {
    DispatchQueue.main.async {
        self.loadButton.isEnabled = true
        if let error = error {
            handleClientError(error)
        } else if let receivedData = self.receivedData,
            let string = String(data: receivedData, encoding: .utf8) {
            self.webView.loadHTMLString(string, baseURL: task.currentRequest?.url)
        }
    }
}
~~~

- urlSession(_:dataTask:didReceive:completionHandler:)
  - ì‘ë‹µì— ì„±ê³µì ì¸ HTTP ìƒíƒœ ì½”ë“œê°€ ìˆëŠ”ì§€, MIME ìœ í˜•ì´ text/html ë˜ëŠ” text/plain ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  - ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ë˜ì§€ ì•Šìœ¼ë©´ ì‘ì—…ì´ ì·¨ì†Œë©ë‹ˆë‹¤.
- urlSession(_:dataTask:didReceive:)
  - Data ì‘ì—…ì—ì„œ ìˆ˜ì‹ í•œ ê° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ ì™€ì„œ receivedData ë¼ëŠ” ë³€ìˆ˜ì— ì¶”ê°€í•©ë‹ˆë‹¤.
- urlSession(_:task:didCompleteWithError:)
  - ë¨¼ì € ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  - ì˜¤ë¥˜ê°€ nil ì´ë©´ receivedData ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ receivedDatawebView ì˜ ë‚´ìš©ìœ¼ë¡œ ì„¤ì •ì„ ì‹œë„í•©ë‹ˆë‹¤.
 
**delegate protocol ì„ ì‚¬ìš©í•˜ë©´ ì¸ì¦ ë¬¸ì œ ì²˜ë¦¬, ë¦¬ë‹¤ì´ë ‰ì…˜ ì¶”ì  ë° ê¸°íƒ€ íŠ¹ìˆ˜ ì‚¬ë¡€ë¥¼ ìœ„í•´ ìœ„ ì½”ë“œì— í‘œì‹œëœ ê²ƒ ì²˜ëŸ¼ ë‹¤ì–‘í•œ ë°©ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

***

### âš ï¸ ì°¸ê³ ìë£Œ
- [Apple Documentation - URLSession](https://developer.apple.com/documentation/foundation/urlsession)
- [Apple Documentation - URLSessionConfiguration](https://developer.apple.com/documentation/foundation/urlsessionconfiguration)
- [Apple Documentation - URLSessionTask](https://developer.apple.com/documentation/foundation/urlsessiontask)
- [Apple Documentation - Fetching website data into memory](https://developer.apple.com/documentation/foundation/url_loading_system/fetching_website_data_into_memory#2923296)
- [Blog - URLSession(1) - ê°œë… ëª¨ì•„ë³´ê¸°(URLSession, URLSessionConfiguration, URLSessionTask)](https://jazz-the-it.tistory.com/19)
- [Blog - URLSession ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì(2/2) - ì‹¤ì „](https://gyuios.tistory.com/108)
